{% extends 'restaurant/base.html' %}

{% block title %}Dashboard Cocinero - AbbaHotel- Restaurante{% endblock %}

{% block body_class %}bg-gray-50 text-gray-800{% endblock %}

{% block extra_head %}
    <style>
        .order-card {
            transition: all 0.3s ease-in-out;
            border-left-width: 8px;
        }
        .order-card-new { 
            border-color: #FBBF24; /* amber-400 */
            background-color: #FFFBEB; /* amber-50 */
        }
        .order-card-medium { 
            border-color: #D97706; /* amber-600 */
            background-color: #FEF3C7; /* amber-100 */
        }
        .order-card-old { 
            border-color: #92400E; /* amber-800 */
            background-color: #FED7AA; /* amber-200 */
        }
        .order-card-urgent {
            border-color: #EF4444; /* red-500 */
            background-color: #FECACA; /* red-200 */
        }
        .order-card-critical {
            border-color: #DC2626; /* red-600 */
            background-color: #FCA5A5; /* red-300 */
            animation: pulse-critical 1.5s ease-in-out infinite;
        }
        @keyframes pulse-critical {
            0%, 100% { background-color: #FCA5A5; }
            50% { background-color: #F87171; }
        }

        /* Ocultar la barra de scroll pero permitir el desplazamiento */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom Toast Notification Styles */
        .toast {
            position: fixed;
            top: 5%;
            left: 50%;
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translate(-50%, -100px);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        .toast.success { background-color: transparent; color: #22c55e; } /* Green text only */
        .toast.error { background-color: transparent; color: #ef4444; } /* Red text only */
        .toast.info { background-color: transparent; color: #3b82f6; } /* Blue text only */
    </style>
{% endblock %}

{% block content %}
    <div class="fixed top-0 left-0 right-0 bg-white p-2 z-10 flex justify-between items-center border-b border-gray-200 shadow-sm">
        <h1 class="text-2xl font-bold text-gray-900">Panel de Cocina</h1>
        <a href="{% url 'logout' %}" class="text-sm text-red-600 hover:text-red-800">Cerrar Sesi√≥n</a>
    </div>
    
    <div class="flex h-screen pt-14">
        <!-- Columna de Pedidos Recibidos -->
        <div class="w-1/2 border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-gray-100">
                <h2 class="text-2xl font-bold text-center text-amber-800">Recibidos</h2>
            </div>
            <div id="pending-orders" class="flex-grow p-4 overflow-y-auto no-scrollbar">
                {% for order in orders %}
                    {% if order.status == 'pending' %}
                        <!-- La tarjeta se renderizar√° aqu√≠ con JS -->
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    
        <!-- Columna de Pedidos en Preparaci√≥n -->
        <div class="w-1/2 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-gray-100">
                <h2 class="text-2xl font-bold text-center text-amber-800">En Preparaci√≥n</h2>
            </div>
            <div id="preparing-orders" class="flex-grow p-4 overflow-y-auto no-scrollbar">
                {% for order in orders %}
                    {% if order.status == 'preparing' %}
                        <!-- La tarjeta se renderizar√° aqu√≠ con JS -->
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = '{{ csrf_token }}';
        let initialOrders = {{ orders_json|safe }};

        // --- Funciones de Renderizado ---
        function renderOrderCard(order) {
            const itemsHtml = order.items.map(item => `
                <li class="flex justify-between items-center">
                    <span class="font-semibold">${item.quantity}x ${item.name}</span>
                    ${item.note ? `<span class="text-xs text-red-600 italic ml-2">Nota: ${item.note}</span>` : ''}
                </li>
            `).join('');

            const card = document.createElement('div');
            card.id = `order-${order.id}`;
            card.className = 'order-card bg-white rounded-lg shadow-lg p-5 mb-4';
            card.dataset.createdAt = order.created_at;
            card.dataset.orderId = order.id;
            card.dataset.orderStatus = order.status;

            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">Pedido #${order.id}</h3>
                    <span class="timer font-mono text-lg font-semibold text-gray-700">00:00</span>
                </div>
                <p class="text-md text-gray-600 mb-3">Para: <span class="font-semibold">${order.identifier}</span></p>
                <ul class="space-y-2 mb-4">${itemsHtml}</ul>
                <div class="flex justify-end space-x-3 mt-4">
                    ${order.status === 'pending' ? `
                        <button class="start-btn bg-yellow-500 text-white px-5 py-2 rounded-lg font-semibold hover:amber-900" data-order-id="${order.id}">
                            Empezar Preparaci√≥n
                        </button>
                    ` : ''}
                    ${order.status === 'preparing' ? `
                        <button class="ready-btn bg-green-900 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-900" data-order-id="${order.id}">
                            Marcar como Listo
                        </button>
                    ` : ''}
                </div>
            `;
            return card;
        }

        function addOrderToDOM(order) {
            const card = renderOrderCard(order);
            if (order.status === 'pending') {
                document.getElementById('pending-orders').prepend(card);
            } else if (order.status === 'preparing') {
                document.getElementById('preparing-orders').prepend(card);
            }
        }

        function moveOrderToPreparing(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.remove();
                // Buscar la orden en el DOM por data-order-id
                const orderElements = document.querySelectorAll('[data-order-id]');
                let orderData = null;
                
                orderElements.forEach(el => {
                    if (parseInt(el.getAttribute('data-order-id')) === orderId) {
                        orderData = {
                            id: orderId,
                            status: 'preparing',
                            identifier: el.querySelector('p span')?.textContent || 'Unknown',
                            items: [], // No necesitamos los items aqu√≠
                            created_at: el.getAttribute('data-order-created-at')
                        };
                    }
                });
                
                if (orderData) {
                    addOrderToDOM(orderData);
                }
            }
        }

        function removeOrderFromDOM(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.style.transition = 'opacity 0.5s, transform 0.5s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 500);
            }
        }

        // --- L√≥gica de Eventos y API ---
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/restaurant/api/orders/${orderId}/status/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({ status: newStatus }),
                });
                if (!response.ok) throw new Error('Error al actualizar el estado');
                
                // La actualizaci√≥n de la UI se manejar√° por el WebSocket
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al actualizar el pedido.', 'error');
            }
        }

        document.body.addEventListener('click', function(e) {
            if (e.target.matches('.start-btn')) {
                const orderId = parseInt(e.target.dataset.orderId, 10);
                updateOrderStatus(orderId, 'preparing');
            }
            if (e.target.matches('.ready-btn')) {
                const orderId = parseInt(e.target.dataset.orderId, 10);
                updateOrderStatus(orderId, 'ready');
            }
        });

        // --- Temporizadores y Actualizaciones de UI ---
        function updateTimers() {
            document.querySelectorAll('.order-card').forEach(card => {
                const createdAt = new Date(card.dataset.createdAt);
                const now = new Date();
                const diffSeconds = Math.floor((now - createdAt) / 1000);
                
                const minutes = Math.floor(diffSeconds / 60);
                const seconds = diffSeconds % 60;
                
                card.querySelector('.timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Remover todas las clases de color previas
                card.classList.remove('order-card-new', 'order-card-medium', 'order-card-old', 'order-card-urgent', 'order-card-critical');

                // Actualizar color del borde y fondo seg√∫n la antig√ºedad
                if (minutes >= 15) {
                    card.classList.add('order-card-critical'); // Rojo pulsante
                } else if (minutes >= 10) {
                    card.classList.add('order-card-urgent'); // Rojo fuerte
                } else if (minutes >= 7) {
                    card.classList.add('order-card-old'); // √Åmbar oscuro
                } else if (minutes >= 5) {
                    card.classList.add('order-card-medium'); // √Åmbar medio
                } else {
                    card.classList.add('order-card-new'); // √Åmbar claro
                }
            });
        }

        // --- L√≥gica de Pusher para Tiempo Real ---
        function setupPusher() {
            console.log('[PUSHER] PUSHER_KEY:', PUSHER_KEY);
            console.log('[PUSHER] PUSHER_CLUSTER:', PUSHER_CLUSTER);
            if (!PUSHER_KEY) {
                console.error("Pusher key no est√° configurada.");
                return;
            }

            Pusher.logToConsole = true;
            const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
            const channel = pusher.subscribe('cocina-channel');
            console.log('[PUSHER] Suscrito a cocina-channel');

            channel.bind('nuevo-pedido', function(data) {
                console.log('Nuevo pedido recibido via Pusher:', data.order);
                showToast(`Nuevo pedido para ${data.order.identifier}`, 'info');
                addOrderToDOM(data.order);
            });

            channel.bind('actualizacion-estado', function(data) {
                console.log('Actualizaci√≥n de estado recibida:', data.order);
                const order = data.order;
                if (order.status === 'preparing') {
                    moveOrderToPreparing(order.id);
                } else if (order.status === 'ready' || order.status === 'cancelled') {
                    removeOrderFromDOM(order.id);
                }
            });
        }

        // --- Polling autom√°tico como backup (cada 2 segundos) ---
        let lastSyncTimestamp = 0;
        async function syncOrdersWithServer() {
            try {
                const now = Date.now();
                if (now - lastSyncTimestamp < 1500) {
                    return; // Evitar sincronizaciones muy frecuentes
                }
                lastSyncTimestamp = now;

                console.log('[SYNC] Sincronizando √≥rdenes...');
                const response = await fetch("{% url 'restaurant:api_orders' %}");
                if (!response.ok) {
                    console.error('[SYNC] Error en respuesta:', response.status, response.statusText);
                    const text = await response.text();
                    console.error('[SYNC] Respuesta:', text.substring(0, 200));
                    return;
                }
                
                const newOrders = await response.json();
                console.log('[SYNC] √ìrdenes desde servidor:', newOrders.length);
                
                // Obtener IDs de √≥rdenes en pantalla
                const domOrderMap = new Map();
                document.querySelectorAll('[data-order-id]').forEach(el => {
                    const orderId = parseInt(el.getAttribute('data-order-id'));
                    const status = el.getAttribute('data-order-status');
                    domOrderMap.set(orderId, { element: el, status: status });
                });
                
                console.log('[SYNC] √ìrdenes en DOM:', domOrderMap.size);
                
                // Procesar cada orden del servidor
                newOrders.forEach(order => {
                    const domOrder = domOrderMap.get(order.id);
                    
                    if (!domOrder) {
                        // Orden nueva: agregar a pantalla
                        console.log(`[SYNC] ‚úÖ Nueva orden: #${order.id} (${order.identifier})`);
                        addOrderToDOM(order);
                    } else if (domOrder.status !== order.status) {
                        // Orden con estado diferente: actualizar
                        console.log(`[SYNC] üìù Estado cambi√≥: #${order.id} ${domOrder.status} ‚Üí ${order.status}`);
                        
                        if (order.status === 'preparing') {
                            moveOrderToPreparing(order.id);
                        } else if (order.status === 'ready' || order.status === 'cancelled') {
                            removeOrderFromDOM(order.id);
                        }
                    }
                    
                    domOrderMap.delete(order.id);
                });
                
                // Remover √≥rdenes que ya no est√°n en el servidor
                domOrderMap.forEach((domOrder, orderId) => {
                    console.log(`[SYNC] ‚ùå Removiendo orden: #${orderId}`);
                    domOrder.element.remove();
                });
            } catch (error) {
                console.error('[SYNC] Error:', error.message, error);
            }
        }

        // --- Inicializaci√≥n ---
        console.log('[INIT] Iniciando cook dashboard. √ìrdenes iniciales:', initialOrders.length);
        initialOrders.forEach(addOrderToDOM);
        setInterval(updateTimers, 1000);
        setupPusher();
        
        // Ejecutar sync inmediatamente y luego cada 2 segundos
        syncOrdersWithServer(); // Primera sincronizaci√≥n inmediata
        setInterval(syncOrdersWithServer, 2000);
        
        console.log('[INIT] Dashboard listo. Esperando √≥rdenes...');
    });
</script>
{% endblock %}
