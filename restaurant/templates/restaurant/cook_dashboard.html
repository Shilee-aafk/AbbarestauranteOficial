{% extends 'restaurant/base.html' %}

{% block title %}Dashboard Cocinero - AbbaHotel- Restaurante{% endblock %}

{% block body_class %}bg-gray-50 text-gray-800{% endblock %}

{% block extra_head %}
    <style>
        .order-card {
            transition: all 0.3s ease-in-out;
            border-left-width: 8px;
        }
        .order-card-new { 
            border-color: #FBBF24; /* amber-400 */
            background-color: #FFFBEB; /* amber-50 */
        }
        .order-card-medium { 
            border-color: #D97706; /* amber-600 */
            background-color: #FEF3C7; /* amber-100 */
        }
        .order-card-old { 
            border-color: #92400E; /* amber-800 */
            background-color: #FED7AA; /* amber-200 */
        }
        .order-card-urgent {
            border-color: #EF4444; /* red-500 */
            background-color: #FECACA; /* red-200 */
        }
        .order-card-critical {
            border-color: #DC2626; /* red-600 */
            background-color: #FCA5A5; /* red-300 */
            animation: pulse-critical 1.5s ease-in-out infinite;
        }
        @keyframes pulse-critical {
            0%, 100% { background-color: #FCA5A5; }
            50% { background-color: #F87171; }
        }

        /* Ocultar la barra de scroll pero permitir el desplazamiento */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom Toast Notification Styles */
        .toast {
            position: fixed;
            top: 5%;
            left: 50%;
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translate(-50%, -100px);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        .toast.success { background-color: transparent; color: #22c55e; } /* Green text only */
        .toast.error { background-color: transparent; color: #ef4444; } /* Red text only */
        .toast.info { background-color: transparent; color: #3b82f6; } /* Blue text only */
    </style>
{% endblock %}

{% block content %}
    <div class="fixed top-0 left-0 right-0 bg-white p-2 z-10 flex justify-between items-center border-b border-gray-200 shadow-sm">
        <h1 class="text-2xl font-bold text-gray-900">Panel de Cocina</h1>
        <a href="{% url 'logout' %}" class="text-sm text-red-600 hover:text-red-800">Cerrar Sesión</a>
    </div>
    
    <div class="flex h-screen pt-14">
        <!-- Columna de Pedidos Recibidos -->
        <div class="w-1/2 border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-gray-100">
                <h2 class="text-2xl font-bold text-center text-amber-800">Recibidos</h2>
            </div>
            <div id="pending-orders" class="flex-grow p-4 overflow-y-auto no-scrollbar">
                {% for order in orders %}
                    {% if order.status == 'pending' %}
                        <!-- La tarjeta se renderizará aquí con JS -->
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    
        <!-- Columna de Pedidos en Preparación -->
        <div class="w-1/2 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-gray-100">
                <h2 class="text-2xl font-bold text-center text-amber-800">En Preparación</h2>
            </div>
            <div id="preparing-orders" class="flex-grow p-4 overflow-y-auto no-scrollbar">
                {% for order in orders %}
                    {% if order.status == 'preparing' %}
                        <!-- La tarjeta se renderizará aquí con JS -->
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = '{{ csrf_token }}';
        let initialOrders = {{ orders_json|safe }};

        // --- Funciones de Renderizado ---
        function renderOrderCard(order) {
            const itemsHtml = order.items.map(item => `
                <li class="flex justify-between items-center">
                    <span class="font-semibold">${item.quantity}x ${item.name}</span>
                    ${item.note ? `<span class="text-xs text-red-600 italic ml-2">Nota: ${item.note}</span>` : ''}
                </li>
            `).join('');

            const card = document.createElement('div');
            card.id = `order-${order.id}`;
            card.className = 'order-card bg-white rounded-lg shadow-lg p-5 mb-4';
            card.dataset.createdAt = order.created_at;

            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xl font-bold text-gray-800">Pedido #${order.id}</h3>
                    <span class="timer font-mono text-lg font-semibold text-gray-700">00:00</span>
                </div>
                <p class="text-md text-gray-600 mb-3">Para: <span class="font-semibold">${order.identifier}</span></p>
                <ul class="space-y-2 mb-4">${itemsHtml}</ul>
                <div class="flex justify-end space-x-3 mt-4">
                    ${order.status === 'pending' ? `
                        <button class="start-btn bg-yellow-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-yellow-600" data-order-id="${order.id}">
                            Empezar Preparación
                        </button>
                    ` : ''}
                    ${order.status === 'preparing' ? `
                        <button class="ready-btn bg-green-900 text-white px-5 py-2 rounded-lg font-semibold hover:bg-green-900" data-order-id="${order.id}">
                            Marcar como Listo
                        </button>
                    ` : ''}
                </div>
            `;
            return card;
        }

        function addOrderToDOM(order) {
            const card = renderOrderCard(order);
            if (order.status === 'pending') {
                document.getElementById('pending-orders').prepend(card);
            } else if (order.status === 'preparing') {
                document.getElementById('preparing-orders').prepend(card);
            }
        }

        function moveOrderToPreparing(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.remove();
                // Simulamos la actualización del estado y volvemos a renderizar
                const orderData = initialOrders.find(o => o.id === orderId);
                if (orderData) {
                    orderData.status = 'preparing';
                    addOrderToDOM(orderData);
                }
            }
        }

        function removeOrderFromDOM(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.style.transition = 'opacity 0.5s, transform 0.5s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => card.remove(), 500);
            }
        }

        // --- Lógica de Eventos y API ---
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/restaurant/api/orders/${orderId}/status/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({ status: newStatus }),
                });
                if (!response.ok) throw new Error('Error al actualizar el estado');
                
                // La actualización de la UI se manejará por el WebSocket
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al actualizar el pedido.', 'error');
            }
        }

        document.body.addEventListener('click', function(e) {
            if (e.target.matches('.start-btn')) {
                const orderId = parseInt(e.target.dataset.orderId, 10);
                updateOrderStatus(orderId, 'preparing');
            }
            if (e.target.matches('.ready-btn')) {
                const orderId = parseInt(e.target.dataset.orderId, 10);
                updateOrderStatus(orderId, 'ready');
            }
        });

        // --- Temporizadores y Actualizaciones de UI ---
        function updateTimers() {
            document.querySelectorAll('.order-card').forEach(card => {
                const createdAt = new Date(card.dataset.createdAt);
                const now = new Date();
                const diffSeconds = Math.floor((now - createdAt) / 1000);
                
                const minutes = Math.floor(diffSeconds / 60);
                const seconds = diffSeconds % 60;
                
                card.querySelector('.timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // Remover todas las clases de color previas
                card.classList.remove('order-card-new', 'order-card-medium', 'order-card-old', 'order-card-urgent', 'order-card-critical');

                // Actualizar color del borde y fondo según la antigüedad
                if (minutes >= 15) {
                    card.classList.add('order-card-critical'); // Rojo pulsante
                } else if (minutes >= 10) {
                    card.classList.add('order-card-urgent'); // Rojo fuerte
                } else if (minutes >= 7) {
                    card.classList.add('order-card-old'); // Ámbar oscuro
                } else if (minutes >= 5) {
                    card.classList.add('order-card-medium'); // Ámbar medio
                } else {
                    card.classList.add('order-card-new'); // Ámbar claro
                }
            });
        }

        // --- Lógica de Pusher para Tiempo Real ---
        function setupPusher() {
            if (!PUSHER_KEY) {
                console.error("Pusher key no está configurada.");
                return;
            }

            Pusher.logToConsole = true;
            const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
            const channel = pusher.subscribe('cocina-channel');

            channel.bind('nuevo-pedido', function(data) {
                console.log('Nuevo pedido recibido via Pusher:', data.order);
                showToast(`Nuevo pedido para ${data.order.identifier}`, 'info');
                addOrderToDOM(data.order);
            });

            channel.bind('actualizacion-estado', function(data) {
                console.log('Actualización de estado recibida:', data.order);
                const order = data.order;
                if (order.status === 'preparing') {
                    moveOrderToPreparing(order.id);
                } else if (order.status === 'ready' || order.status === 'cancelled') {
                    removeOrderFromDOM(order.id);
                }
            });
        }

        // --- Polling automático como backup (cada 10 segundos) ---
        async function syncOrdersWithServer() {
            try {
                const response = await fetch("{% url 'restaurant:api_orders' %}");
                if (!response.ok) return;
                
                const newOrders = await response.json();
                console.log('[SYNC] Órdenes desde servidor:', newOrders);
                
                // Sincronizar órdenes: agregar nuevas y remover completadas
                const currentOrderIds = new Set();
                document.querySelectorAll('[data-order-id]').forEach(el => {
                    currentOrderIds.add(parseInt(el.getAttribute('data-order-id')));
                });
                
                // Agregar órdenes nuevas
                newOrders.forEach(order => {
                    if (!currentOrderIds.has(order.id)) {
                        console.log(`[SYNC] Agregando nueva orden: ${order.id}`);
                        addOrderToDOM(order);
                    }
                });
                
                // Remover órdenes completadas
                document.querySelectorAll('[data-order-id]').forEach(el => {
                    const orderId = parseInt(el.getAttribute('data-order-id'));
                    if (!newOrders.some(o => o.id === orderId)) {
                        console.log(`[SYNC] Removiendo orden completada: ${orderId}`);
                        el.remove();
                    }
                });
            } catch (error) {
                console.error('[SYNC] Error sincronizando órdenes:', error);
            }
        }

        // --- Inicialización ---
        initialOrders.forEach(addOrderToDOM);
        setInterval(updateTimers, 1000);
        setupPusher();
        
        // Polling cada 10 segundos como backup
        setInterval(syncOrdersWithServer, 10000);
    });
</script>
{% endblock %}
